<!DOCTYPE html>
<html lang="en" class="h-full bg-[#0a0a0a]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilbeny's Bookmarks</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script async src="https://platform.twitter.com/widgets.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .content-area { max-width: 680px; }
        .profile-pic img {
            width: 64px;  /* or your original size */
            height: 64px;
            border-radius: 50%;
        }
        .error-details {
            background-color: #fdf2f2;
            border-left: 4px solid #f56565;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .error-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #c53030;
        }

        .memory-warning {
            background-color: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }

        .timeout-info {
            background-color: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }
    </style>
    
    {% block head %}
    <script>
    /* Array to store selected categories */
    let selectedCategories = [];

    /* Initialize with category_filter if available */
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof categoryFilter !== 'undefined' && categoryFilter) {
            selectedCategories.push(categoryFilter);
            highlightSelectedCategories();
        }
    });

    /* Toggle category selection */
    function toggleCategory(categoryName) {
        const index = selectedCategories.indexOf(categoryName);
        
        if (index === -1) {
            /* Category not selected, add it */
            selectedCategories.push(categoryName);
        } else {
            /* Category already selected, remove it */
            selectedCategories.splice(index, 1);
        }
        
        /* Update UI to reflect selection */
        highlightSelectedCategories();
        
        // Remove the immediate redirect - let user manually submit
        // This allows multi-selection of categories without triggering search
    }

    /* Highlight selected category buttons */
    function highlightSelectedCategories() {
        document.querySelectorAll('.category-btn').forEach(btn => {
            const category = btn.getAttribute('data-category');
            if (selectedCategories.includes(category)) {
                btn.classList.add('bg-blue-900', 'text-blue-200');
                btn.classList.remove('bg-[#1a1a1a]', 'text-gray-400');
            } else {
                btn.classList.remove('bg-blue-900', 'text-blue-200');
                btn.classList.add('bg-[#1a1a1a]', 'text-gray-400');
            }
        });
    }

    /* Build a URL with selected categories */
    function buildCategoryUrl(baseUrl) {
        if (selectedCategories.length === 0) {
            return baseUrl;
        }
        
        let url = baseUrl + '?';
        selectedCategories.forEach((category, index) => {
            if (index > 0) url += '&';
            url += `categories[]=${encodeURIComponent(category)}`;
        });
        
        return url;
    }

    /* Submit search form with selected categories */
    function submitSearchWithCategories(event) {
        /* Show loading spinner */
        showSearchLoading();
        
        /* Clear previous category inputs */
        document.getElementById('category-inputs').innerHTML = '';
        
        /* Add hidden inputs for each selected category */
        selectedCategories.forEach(category => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'categories[]';
            input.value = category;
            document.getElementById('category-inputs').appendChild(input);
        });
        
        /* Let the form submit normally */
    }

    // Add a new function to submit a category-only search
    function submitCategoriesOnly() {
        if (selectedCategories.length === 0) {
            // If no categories selected, just go to recent
            window.location.href = '/recent';
            return;
        }
        
        // Construct URL with selected categories
        let url = '/search?';
        selectedCategories.forEach((category, index) => {
            if (index > 0) url += '&';
            url += `categories[]=${encodeURIComponent(category)}`;
        });
        
        // Navigate to the URL
        window.location.href = url;
    }

    /* Show search loading indicator */
    function showSearchLoading() {
        document.getElementById('search-loading').classList.remove('hidden');
    }
    </script>
    {% endblock %}
</head>

<body class="h-full bg-[#0a0a0a] text-white" 
      x-data="{ 
          searchOpen: false, 
          searchByUser: false, 
          uploadModal: false, 
          selectedFile: null,
          uploadStatus: '',
          uploadMessage: '',
          isProcessing: false,
          progressSteps: []
      }"
      @file-selected.window="handleFileSelect($event.detail)">
    <!-- Main content - centered -->
    <div class="min-h-screen flex flex-col items-center px-6">
        <!-- Logo section -->
        <div class="mt-8 mb-6 flex flex-col items-center">
            <a href="/" class="profile-link">
                <div class="profile-pic">
                    <img src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Profile Picture">
                </div>
            </a>
            <h1 class="mt-3 text-xl font-bold text-gray-200">
                Bilbeny's Bookmarks
            </h1>
        </div>

        <!-- Search and filters container -->
        <div class="content-area w-full">
            <!-- Search bar -->
            <form id="search-form" action="/search" method="get" class="relative" 
                  onsubmit="submitSearchWithCategories(event)">
                <div class="flex">
                    <div class="relative flex-grow">
                        <input 
                            type="text" 
                            name="q"
                            value="{{ query|default('', true) }}"
                            placeholder="Search bookmarks..."
                            class="block w-full bg-[#1a1a1a] border-0 rounded-l-lg py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-500 focus:ring-1 focus:ring-gray-700"
                        >
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                    <!-- Filter by Category Button -->
                    <button 
                        type="submit"
                        class="px-3 py-2.5 bg-blue-600 text-white rounded-r-lg text-sm hover:bg-blue-700 flex items-center"
                    >
                        <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Search
                    </button>
                </div>
                <!-- Hidden inputs for categories will be added dynamically -->
                <div id="category-inputs"></div>
            </form>

            <!-- Search loading indicator -->
            <div id="search-loading" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-500"></div>
            </div>

            <!-- Main buttons row -->
            <div class="mt-3 flex flex-wrap items-center justify-between gap-1.5">
                <!-- Left side: Recent and Search by User -->
                <div class="flex gap-1.5">
                    <a href="/recent"
                       class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-gray-400 hover:bg-gray-800 transition-colors">
                        All Bookmarks
                    </a>
                    
                    <button 
                        @click="searchByUser = true"
                        class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-gray-400 hover:bg-gray-800 transition-colors">
                        Search by User
                    </button>
                </div>

                <!-- Right side: Chat and Update DB -->
                <div class="flex gap-1.5">
                    <a href="/chat"
                       class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-blue-400 hover:bg-gray-800 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                        Chat
                    </a>

                    {% if is_admin %}
                    <a href="/admin/monitor" 
                       class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-blue-400 hover:bg-gray-800 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Monitor
                    </a>
                    {% endif %}

                    <a href="/manage/categories" 
                       class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-blue-400 hover:bg-gray-800 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10m-5-5v10m-7 5h14"></path>
                        </svg>
                        Manage Categories
                    </a>

                    <button 
                        @click="uploadModal = true"
                        class="px-3 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-blue-400 hover:bg-gray-800 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Update DB
                    </button>
                </div>
            </div>

            <!-- Categories row (below main buttons) -->
            <div class="navbar-section mb-4">
                <!-- Categories display - PythonAnywhere specific rendering -->
                <div id="base-categories" class="mt-3 flex flex-wrap gap-1.5">
                    {% for category in categories %}
                        {% if category is mapping %}
                            <button 
                                data-category="{{ category.name }}"
                                class="category-btn px-2 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-gray-400 hover:bg-gray-800 transition-colors {% if category_filter == category.name %}bg-blue-900 text-blue-200{% endif %}"
                                onclick="toggleCategory('{{ category.name }}')">
                                {{ category.name }} {% if category.count %}({{ category.count }}){% endif %}
                            </button>
                        {% else %}
                            <button 
                                data-category="{{ category }}"
                                class="category-btn px-2 py-1 rounded-md text-xs font-medium bg-[#1a1a1a] text-gray-400 hover:bg-gray-800 transition-colors {% if category_filter == category %}bg-blue-900 text-blue-200{% endif %}"
                                onclick="toggleCategory('{{ category }}')">
                                {{ category }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- User Search Modal -->
            <div x-show="searchByUser" 
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
                 @click.away="searchByUser = false"
                 x-cloak>
                <div class="bg-[#1a1a1a] p-6 rounded-lg w-96">
                    <h3 class="text-lg font-medium mb-4">Search by Twitter User</h3>
                    <form action="/search" method="get">
                        <input 
                            type="text" 
                            name="user"
                            placeholder="Enter Twitter username..."
                            class="block w-full bg-[#2a2a2a] border-0 rounded-lg py-2 px-4 text-sm text-white placeholder-gray-500 focus:ring-1 focus:ring-gray-700 mb-4"
                        >
                        <div class="flex justify-end">
                            <button 
                                type="button" 
                                @click="searchByUser = false"
                                class="mr-3 px-4 py-2 text-sm text-gray-400 hover:text-white"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                            >
                                Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- New Upload Modal -->
            <div x-show="uploadModal" 
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
                 @click.away="uploadModal = false"
                 x-cloak>
                <div class="bg-[#1a1a1a] p-6 rounded-lg w-96">
                    <h3 class="text-lg font-medium mb-4">Update Bookmark Database</h3>
                    
                    <!-- Upload Form -->
                    <form id="upload-form" 
                          class="space-y-4" 
                          @submit.prevent="handleUpload"
                          enctype="multipart/form-data">
                        <!-- File Input Container -->
                        <div class="border-2 border-dashed border-gray-700 rounded-lg p-4 text-center">
                            <input type="file" 
                                   id="json-file" 
                                   accept=".json"
                                   class="hidden"
                                   onchange="handleFileSelectDirect(this)">
                            
                            <div class="space-y-2">
                                <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                
                                <div class="text-sm text-gray-400">
                                    <label for="json-file" class="cursor-pointer text-blue-400 hover:text-blue-300">
                                        Choose a file
                                    </label>
                                    or drag it here
                                </div>
                                
                                <div id="file-name" class="text-sm text-blue-400"></div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div id="progress-steps" class="mt-4 space-y-2" style="display: none;">
                            <div id="step-upload" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Uploading file...</span>
                            </div>
                            <div id="step-validate" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Validating JSON...</span>
                            </div>
                            <div id="step-find-new" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Finding new bookmarks...</span>
                            </div>
                            <div id="step-init-ai" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Initializing AI models...</span>
                            </div>
                            <div id="step-dedup" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Checking for duplicates...</span>
                            </div>
                            <div id="step-sql" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Updating SQL database...</span>
                            </div>
                            <div id="step-categories" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Processing categories...</span>
                            </div>
                            <div id="step-vectors" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Rebuilding vector store...</span>
                            </div>
                            <div id="step-sync" class="flex items-center gap-2">
                                <span class="progress-icon">⭕</span>
                                <span class="text-sm text-gray-400">Verifying database sync...</span>
                            </div>
                        </div>

                        <!-- Upload Button -->
                        <div id="upload-actions" class="flex justify-end gap-3 mt-4" style="display: none;">
                            <button 
                                type="button"
                                onclick="console.log('Button clicked'); window.handleUploadDirect(); return false;"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                                Upload and Update Database
                            </button>
                        </div>

                        <!-- Advanced Options -->
                        <div id="advanced-options" class="mt-4 border-t border-gray-700 pt-4">
                            <details class="text-sm">
                                <summary class="cursor-pointer text-gray-300 hover:text-white">Advanced Options</summary>
                                <div class="mt-3 flex flex-col gap-3">
                                    <div class="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            id="rebuild-vector" 
                                            class="mr-2 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600"
                                        >
                                        <label for="rebuild-vector" class="text-gray-300">Rebuild Vector Store</label>
                                    </div>
                                    <p class="text-xs text-gray-400 ml-6 -mt-1">
                                        Use this if search results are incorrect or missing. This rebuilds the search index from the database.
                                    </p>
                                    
                                    <div class="flex items-center mt-2">
                                        <input 
                                            type="checkbox" 
                                            id="reset-progress" 
                                            class="mr-2 rounded bg-gray-700 border-gray-600 text-yellow-500 focus:ring-yellow-600"
                                        >
                                        <label for="reset-progress" class="text-gray-300">Reset Update Progress</label>
                                    </div>
                                    <p class="text-xs text-gray-400 ml-6 -mt-1">
                                        Use this if database updates are stuck in a loop or not completing. This will start the process from the beginning.
                                    </p>
                                    
                                    <!-- Legacy buttons - keep for backward compatibility but hide with JavaScript -->
                                    <div id="legacy-buttons" style="display: none;">
                                        <div>
                                            <button 
                                                type="button"
                                                onclick="rebuildVectorStore()"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                                                Rebuild Vector Store
                                            </button>
                                        </div>
                                        <div>
                                            <button 
                                                type="button"
                                                onclick="resetUpdateProgress()"
                                                class="px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm hover:bg-yellow-700">
                                                Reset Update Progress
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- Progress Messages -->
                        <div x-show="progressSteps.length > 0" class="mt-4 p-4 bg-[#1a1a1a] rounded-lg">
                            <template x-for="(step, index) in progressSteps" :key="index">
                                <div class="flex items-center gap-2 mb-2">
                                    <span x-show="step.status === 'processing'" class="animate-spin h-4 w-4">⚡</span>
                                    <span x-show="step.status === 'done'" class="text-green-500">✓</span>
                                    <span x-show="step.status === 'error'" class="text-red-500">✗</span>
                                    <span x-text="step.message" :class="{
                                        'text-gray-400': step.status === 'processing',
                                        'text-green-500': step.status === 'done',
                                        'text-red-500': step.status === 'error'
                                    }"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Buttons -->
                        <div class="flex justify-end gap-3 mt-4">
                            <button 
                                type="button" 
                                @click="uploadModal = false"
                                :disabled="isProcessing"
                                class="px-4 py-2 text-sm text-gray-400 hover:text-white disabled:opacity-50">
                                Close
                            </button>
                            
                            <button 
                                x-ref="updateDatabaseBtn"
                                x-show="uploadStatus === 'success'"
                                type="button"
                                @click="updateDatabase"
                                :disabled="isProcessing"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 disabled:opacity-50">
                                <span x-show="!isProcessing">Update Database</span>
                                <span x-show="isProcessing">Processing...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Main content area -->
            <main class="mt-6">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script>
    // File handling functions
    function handleFileDrop(event) {
        event.preventDefault();
        const file = event.dataTransfer.files[0];
        if (file && file.name.endsWith('.json')) {
            // Debug log
            console.log('File dropped:', file.name);
            // Update Alpine.js state
            this.selectedFile = file.name;
            // Update file input
            document.getElementById('json-file').files = event.dataTransfer.files;
            // Update UI
            document.querySelector('.text-blue-400').textContent = file.name;
        }
    }

    // Add this to debug the form submission
    async function handleUpload(event) {
        event.preventDefault();
        
        const fileInput = document.getElementById('json-file');
        const file = fileInput.files[0];
        
        if (!file) {
            console.log('No file selected');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/upload-bookmarks', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (response.ok) {
                this.uploadStatus = 'success';
                this.uploadMessage = 'File uploaded successfully! Click "Update Database" to process the new data.';
                // Show the Update Database button
                this.$refs.updateDatabaseBtn.classList.remove('hidden');
            } else {
                this.uploadStatus = 'error';
                this.uploadMessage = result.error || 'Error processing file';
            }
        } catch (error) {
            console.error('Upload error:', error);
            this.uploadStatus = 'error';
            this.uploadMessage = 'Error uploading file';
        }
    }

    // Add new function to handle database update
    async function updateDatabase() {
        this.isProcessing = true;
        this.progressSteps = [
            { status: 'processing', message: 'Starting database update...' }
        ];
        
        // Get form data
        const rebuildVector = document.getElementById('rebuild-vector') ? 
            document.getElementById('rebuild-vector').checked : false;
        const resetProgress = document.getElementById('reset-progress') ? 
            document.getElementById('reset-progress').checked : false;

        try {
            // Use the async endpoint instead
            const response = await fetch('/async-update-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rebuild_vector: rebuildVector,
                    reset_progress: resetProgress
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.progressSteps = [
                    { status: 'done', message: 'Processing started in background' },
                    { status: 'processing', message: 'Update running in background...' }
                ];
                
                // Start polling for updates
                const sessionId = result.session_id;
                this.pollStatus(sessionId);
            } else {
                this.progressSteps.push(
                    { status: 'error', message: result.error || 'Error starting database update' }
                );
                this.isProcessing = false;
            }
        } catch (error) {
            console.error('Database update error:', error);
            this.progressSteps.push(
                { status: 'error', message: 'Error connecting to server' }
            );
            this.isProcessing = false;
        }
    }
    
    // New function to poll status
    async function pollStatus(sessionId) {
        try {
            const response = await fetch(`/update-status?session_id=${sessionId}`);
            const result = await response.json();
            
            if (response.ok) {
                // Update progress UI based on status
                updateProgressFromStatus(result);
                
                // If not complete, continue polling
                if (!result.is_complete) {
                    setTimeout(() => this.pollStatus(sessionId), 2000); // Poll every 2 seconds
                } else {
                    // Process completed
                    this.progressSteps = [
                        { status: 'done', message: 'File validated' },
                        { status: 'done', message: 'SQL database updated' },
                        { status: 'done', message: 'Vector store rebuilt' },
                        { status: 'done', message: result.message || 'Update completed successfully!' }
                    ];
                    
                    // Wait 3 seconds before allowing close
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    this.isProcessing = false;
                }
            } else {
                // Handle error in status check
                this.progressSteps.push(
                    { status: 'error', message: result.error || 'Error checking update status' }
                );
                this.isProcessing = false;
            }
        } catch (error) {
            console.error('Status polling error:', error);
            this.progressSteps.push(
                { status: 'error', message: 'Error connecting to server during status check' }
            );
            this.isProcessing = false;
        }
    }
    
    // Function to update progress UI from status response
    function updateProgressFromStatus(status) {
        // Update step messages based on status
        const progress = status.progress || {};
        const totalProcessed = progress.total_processed || 0;
        const newCount = progress.new_count || 0;
        const updatedCount = progress.updated_count || 0;
        const errors = progress.errors || 0;
        
        this.progressSteps = [
            { status: 'done', message: 'Processing started in background' },
            { status: 'processing', message: `Processing bookmarks: ${totalProcessed} total, ${newCount} new, ${updatedCount} updated, ${errors} errors` }
        ];
        
        if (status.status === 'completed') {
            this.progressSteps.push(
                { status: 'done', message: 'Update completed successfully!' }
            );
        } else if (status.status === 'error') {
            this.progressSteps.push(
                { status: 'error', message: status.message || 'Error during update' }
            );
        }
    }

    function handleFileSelect(event) {
        console.log('handleFileSelect called');
        
        // Handle both direct events and dispatched events
        const file = event.target ? event.target.files[0] : event.detail.target.files[0];
        console.log('File:', file);
        
        if (file && file.name.endsWith('.json')) {
            console.log('Valid JSON file selected:', file.name);
            this.selectedFile = file.name;
            this.uploadStatus = ''; // Reset status for new file
        } else {
            console.log('Invalid or no file selected');
        }
    }

    function handleFileSelectDirect(input) {
        console.log('File input changed');
        const file = input.files[0];
        
        if (file && file.name.endsWith('.json')) {
            console.log('Selected file:', file.name);
            document.getElementById('file-name').textContent = file.name;
            // Show upload button
            document.getElementById('upload-actions').style.display = 'flex';
        } else {
            console.log('Invalid or no file selected');
            document.getElementById('file-name').textContent = 'Please select a JSON file';
            document.getElementById('upload-actions').style.display = 'none';
        }
    }

    function updateProgress(step, status) {
        const element = document.getElementById(`step-${step}`);
        if (element) {
            const icon = element.querySelector('.progress-icon');
            switch(status) {
                case 'processing':
                    icon.textContent = '⚡';
                    break;
                case 'done':
                    icon.textContent = '✅';
                    break;
                case 'error':
                    icon.textContent = '❌';
                    break;
                default:
                    icon.textContent = '⭕';
            }
        }
    }

    let updateInProgress = false;
    let currentStartIndex = 0;
    let maxRetries = 3;
    let retryCount = 0;
    let updateTimeout = null;

    async function continueProcessing() {
        if (!updateInProgress) return;
        
        try {
            const response = await fetch('/update-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ start_index: currentStartIndex })
            });
            
            const result = await response.json();
            
            if (response.status === 202) {  // Processing should continue
                // Update progress
                const progress = result.progress;
                if (progress) {
                    updateProgressUI(progress);
                }
                
                // Schedule next batch
                currentStartIndex = result.next_index;
                retryCount = 0;  // Reset retry count on successful batch
                
                // Wait a bit before next batch to prevent overload
                updateTimeout = setTimeout(continueProcessing, 1000);
            } else if (response.status === 200) {  // Processing complete
                updateInProgress = false;
                
                // Handle timeout cases
                if (result.is_timeout) {
                    const details = `Processing timed out after ${result.duration_seconds?.toFixed(1) || '?'} seconds. ${result.processed_this_session || '?'} bookmarks were processed. You can continue later.`;
                    showSuccess("Processing partially completed due to timeout", details);
                } else {
                    updateProgressUI(result.progress, true);
                    const details = result.message || `Processed ${result.processed_this_session || '?'} bookmarks in ${result.duration_seconds?.toFixed(1) || '?'} seconds.`;
                    showSuccess("Processing completed successfully!", details);
                }
            } else {
                // Handle error cases with more details
                const errorMessage = result.error || 'Unknown error';
                const errorDetails = result.traceback || result.message || 'No additional details available';
                throw new Error(`${errorMessage}\n${errorDetails}`);
            }
        } catch (error) {
            console.error('Error during processing:', error);
            
            if (retryCount < maxRetries) {
                retryCount++;
                // Exponential backoff
                const delay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                console.log(`Retrying in ${delay}ms (retry ${retryCount}/${maxRetries})`);
                updateTimeout = setTimeout(continueProcessing, delay);
            } else {
                updateInProgress = false;
                showError(`Processing failed after ${maxRetries} retries`, error.toString());
            }
        }
    }

    function updateProgressUI(progress, isComplete = false) {
        const {
            total,
            processed,
            new: newCount,
            updated: updatedCount,
            errors,
            percent_complete
        } = progress;

        // Update progress steps
        document.getElementById('step-upload').querySelector('.progress-icon').textContent = '✅';
        document.getElementById('step-validate').querySelector('.progress-icon').textContent = '✅';
        
        const findNewStep = document.getElementById('step-find-new');
        findNewStep.querySelector('.progress-icon').textContent = '🔄';
        findNewStep.querySelector('span:last-child').textContent = 
            `Finding new bookmarks... (${processed}/${total}, ${percent_complete.toFixed(1)}%)`;
        
        if (isComplete) {
            findNewStep.querySelector('.progress-icon').textContent = '✅';
            document.getElementById('step-sql').querySelector('.progress-icon').textContent = '✅';
            document.getElementById('step-categories').querySelector('.progress-icon').textContent = '✅';
            document.getElementById('step-vectors').querySelector('.progress-icon').textContent = '✅';
            document.getElementById('step-sync').querySelector('.progress-icon').textContent = '✅';
        }
    }

    function showError(message, details = null) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'mt-4 p-4 bg-red-900 text-white rounded-lg';
        
        // Create a header div with important message
        const headerDiv = document.createElement('div');
        headerDiv.className = 'font-bold mb-2';
        headerDiv.textContent = message;
        errorDiv.appendChild(headerDiv);
        
        // Add details in smaller text if provided
        if (details) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'text-sm text-red-200 mb-3';
            detailsDiv.textContent = details;
            errorDiv.appendChild(detailsDiv);
        }
        
        // Add retry button
        const retryButton = document.createElement('button');
        retryButton.className = 'mt-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg mr-2';
        retryButton.textContent = 'Retry';
        retryButton.onclick = function() {
            document.getElementById('progress-steps').removeChild(errorDiv);
            updateInProgress = true;
            currentStartIndex = 0;
            retryCount = 0;
            continueProcessing();
        };
        errorDiv.appendChild(retryButton);
        
        // Add cancel button
        const cancelButton = document.createElement('button');
        cancelButton.className = 'mt-2 px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded-lg';
        cancelButton.textContent = 'Cancel';
        cancelButton.onclick = function() {
            document.getElementById('progress-steps').removeChild(errorDiv);
        };
        errorDiv.appendChild(cancelButton);
        
        document.getElementById('progress-steps').appendChild(errorDiv);
    }

    function showSuccess(message, details = null) {
        const successDiv = document.createElement('div');
        successDiv.className = 'mt-4 p-4 bg-green-900 text-white rounded-lg';
        
        // Create a header div with important message
        const headerDiv = document.createElement('div');
        headerDiv.className = 'font-bold mb-2';
        headerDiv.textContent = message;
        successDiv.appendChild(headerDiv);
        
        // Add details in smaller text if provided
        if (details) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'text-sm text-green-200';
            detailsDiv.textContent = details;
            successDiv.appendChild(detailsDiv);
        }
        
        document.getElementById('progress-steps').appendChild(successDiv);
    }

    // Ensure handleUploadDirect is in global scope
    window.handleUploadDirect = function() {
        console.log("Starting super simple upload function");
        
        // Check if a file is selected
        const fileInput = document.getElementById('json-file');
        if (!fileInput || !fileInput.files.length) {
            alert('Please select a JSON file to upload');
            return;
        }
        
        // Show progress steps
        document.getElementById('progress-steps').style.display = 'block';
        
        // Reset all icons to pending
        document.querySelectorAll('#progress-steps .progress-icon').forEach(icon => {
            icon.textContent = '⭕';
        });
        
        // Set upload step to processing
        document.getElementById('step-upload').querySelector('.progress-icon').textContent = '⚡';
        
        // Create FormData
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        // Display file name
        document.getElementById('file-name').textContent = fileInput.files[0].name;
        
        // Simple fetch upload
        fetch('/upload-bookmarks', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Upload response:", data);
            
            // Mark all steps as completed
            document.querySelectorAll('#progress-steps .progress-icon').forEach(icon => {
                icon.textContent = '✅';
            });
            
            // Show success message
            alert('File uploaded successfully! Your bookmarks will be processed in the background. This may take several minutes. You can close this window and check back later.');
        })
        .catch(error => {
            console.error("Upload error:", error);
            
            // Mark upload step as failed
            document.getElementById('step-upload').querySelector('.progress-icon').textContent = '❌';
            
            // Show error message
            alert('Error uploading file: ' + error.message + '\n\nPlease try again later.');
        });
    };
    
    // Add a function to update progress UI based on status
    function updateAllProgressSteps(isComplete) {
        const steps = [
            'step-upload', 
            'step-validate', 
            'step-find-new', 
            'step-init-ai', 
            'step-dedup', 
            'step-sql', 
            'step-categories', 
            'step-vectors', 
            'step-sync'
        ];
        
        if (isComplete) {
            // Mark all steps as complete
            steps.forEach(stepId => {
                document.getElementById(stepId).querySelector('.progress-icon').textContent = '✅';
            });
        }
    }
    
    // Add polling function to check status
    function pollStatus(sessionId) {
        console.log("Polling status for session:", sessionId);
        
        fetch(`/update-status?session_id=${sessionId}`)
        .then(response => response.json())
        .then(status => {
            console.log("Status update:", status);
            
            if (status.is_complete) {
                updateAllProgressSteps(true);
                alert('Processing completed successfully!');
            } else {
                // Update progress UI with current status
                updateProgressFromStatus(status);
                
                // Continue polling after delay
                setTimeout(() => pollStatus(sessionId), 2000);
            }
        })
        .catch(error => {
            console.error("Error polling status:", error);
            alert("Error checking process status: " + error.message);
        });
    }
    
    // Function to update progress UI from status response
    function updateProgressFromStatus(status) {
        console.log("Updating progress UI with status:", status);
        
        // Update step indicators based on status
        let currentStep = 'step-find-new';
        
        // Reset all icons first
        const allSteps = document.querySelectorAll('#progress-steps .progress-icon');
        allSteps.forEach(icon => {
            icon.textContent = '⭕';
        });
        
        // Mark completed steps
        document.querySelector('#step-upload .progress-icon').textContent = '✅';
        document.querySelector('#step-validate .progress-icon').textContent = '✅';
        
        // Update current processing step
        if (status.current_step) {
            currentStep = `step-${status.current_step.replace(/_/g, '-')}`;
        }
        
        if (document.getElementById(currentStep)) {
            document.getElementById(currentStep).querySelector('.progress-icon').textContent = '⚡';
            
            // Add progress details if available
            const progress = status.progress || {};
            const stepTextEl = document.getElementById(currentStep).querySelector('span:last-child');
            if (stepTextEl && progress.total_processed !== undefined) {
                const baseText = stepTextEl.textContent.split('...')[0] + '...';
                stepTextEl.textContent = `${baseText} (${progress.total_processed} processed, ${progress.new_count || 0} new, ${progress.updated_count || 0} updated)`;
            }
        }
    }

    // Make sure basic functions are available globally
    window.showProgressSteps = function() {
        console.log("Setting up progress steps");
        document.getElementById('progress-steps').style.display = 'block';
    };
    </script>
</body>
</html> 